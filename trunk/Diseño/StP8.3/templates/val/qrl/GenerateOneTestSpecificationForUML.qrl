external string  e_USECASE;

#include "qrl/tsdl_extract.inc"
#include "qrl/basic_textract_dt.inc"
#include "qrl/include/error.inc"

#include "val/qrl/include/table.inc"
#include "val/qrl/include/TConfig.inc"
#include "val/qrl/include/TUseCase.inc"
#include "val/qrl/include/FormatTestCaseData.inc"
#include "val/qrl/include/val_string_globals.inc"   
#include "val/qrl/include/Progress.inc"
#include "val/qrl/include/ValidatorFormats.inc"
#include "val/qrl/include/CreateDir.inc"


  list ScenarioList;

  string OUTPUTPATH = current_projdir() + current_system() + "/test_files/";
  string COMMANDDIR = OUTPUTPATH + "ORACLES/";

  string OUTPUTDIR;


  const int width_1 = 550;
  const int width_2 = 250;
  const int width_3 = 250;
  const int width_4 = 250;
  const int width_5 = 550;

  set ACTORSET;

void main()
{

  initProgress(5);
  initReport();
  // initDebug();

  string test_unit_id;
  string filetext;
  string path;
  string inputfile;
  list testcaselist;

  ACTORSET = GetActors(e_USECASE);
  test_unit_id = Get_T_test_unit_id(e_USECASE, "");
  ScenarioList = GetScenarioList(e_USECASE);
  OUTPUTDIR = OUTPUTPATH + test_unit_id;

  path = OUTPUTDIR + "/UseCaseTestScripts";
  inputfile = path + "/testcases.tcf";
  if (!CheckForSDF(OUTPUTDIR, "TDDB"))
    {
      message ("TDDB for " + test_unit_id + " does not exist.");
      return;
    }

  progress("Format Test Case Data ...", 10);
  if (e_FORMAT_TESTCASE_DATA == True)
    formatTestCaseData(test_unit_id, e_USECASE);
  
  if (CheckForSDF(path, "testcases.tcf"))
  {
     filetext = read_file (inputfile);
     filetext = string_search_and_replace(filetext, "\r", "");
  }
  else
    {
      message ("testcases.tcf for " + test_unit_id + " does not exist.");
      return;
    }

  testcaselist = list_create("string",0);
  testcaselist = string_to_list(filetext, SEPARATOR2);
  
  
  message ("");
  message ("");
  message ("Generating Test Specification Document for Use Case: " + e_USECASE); 
  message ("");

  progress("Printing Title Page ...", 55);
  PrintTitlePage(e_USECASE);

  message ("  Generating Requirements"); 
  progress("Printing Requirements Page ...", 60);
  PrintRequirementsPage(testcaselist, e_USECASE);

  message ("  Printing Metrics");
  progress("Printing Metrics ...", 65);
  PrintMetrics(testcaselist, e_USECASE);

  message ("  Printing Test Cases");
  progress("Printing Test Cases ...", 95);
  PrintScenarioTestCases(testcaselist, e_USECASE);

  doneProgress();

}

void
PrintRequirementsPage (list testcaselist, string e_USECASE)
{

  string test_unit_id;
  int j, count2, count;
  node scenario;
  node nodevar;
  string query = "node[UmlUseCase && name=='${e_USECASE}']";

  paragraph (gsValFormat_Sec1);
  if ((target() == RTF))
     character_format_set(INHEAD);
  print ("Requirements Traceability");

  nodevar = find_by_query(query);

  paragraph (gsValFormat_Sec2);
  print ("Use Case - " + e_USECASE );

  count = list_count(testcaselist);

  ListRequirements( "Use Case", nodevar.id, e_USECASE, count);


  count2 = list_count (ScenarioList);
  for (j=0;j<count2;j=j+1)
    {
      scenario = list_get(ScenarioList,j);

      paragraph (gsValFormat_Sec2);
      print ("Scenario - " + scenario.name );

      count = GetTestCaseCount(scenario.name, testcaselist);

      ListRequirements( "Scenario", scenario.id, scenario.name, count);
    }
}


void
ListRequirements(string rqttype, int id, string name, int tccount)
{

  string query;
  int i,count;
  item itemvar;
  list itemlist;
  string rqts="";
  string ReqType="";

  query = "item[(REQAnalysisAssignmentItem ||
                 REQDesignAssignmentItem || 
                 REQImplementationAssignmentItem || 
                 REQTestAssignmentItem) && ${id} == obj_id]";

  itemlist = list_select(query);

  count = list_count (itemlist);

  paragraph(gsValFormat_description);
  print ( rqttype + " " + name + " has " + tccount);
  print ( " test cases that trace to the following " + count + " requirement(s)" ); 

  for (i=0;i<count;i++)
    {
      itemvar = list_get(itemlist, i);

      if (i==count-1)
         print ("and ");

      print( itemvar.value );
 
      if (i<count-1)
         print (", ");
      else
         print (".");

    }


}


int
GetTestCaseCount(string name, list testcaselist)
{
  int i,count, scenariocount;
  string testcase;
  list textlist;
  list actiondata;
  string  action, exercises, testunitid;
  int testcases = 0;

  count = list_count(testcaselist);

  for (i=0;i<count;i++)
    {

      testcase = list_get(testcaselist,i);

      textlist = string_to_list (testcase, "\n");

      actiondata = string_to_list ( list_get(textlist,0), SEPARATOR);
      action = list_get(actiondata, 0);

      if (action == name)
        ++testcases;
    }
  return (testcases);

}


void
PrintMetrics(list testcaselist, string e_USECASE)
{

   paragraph (gsValFormat_Sec1);
   if ((target() == RTF))
     character_format_set(INHEAD);
   print ("Use Case Metrics");

   UseCaseMetrics( testcaselist, e_USECASE);

   paragraph (gsValFormat_Sec1);
   if ((target() == RTF))
     character_format_set(INHEAD);
   print ("Scenario Metrics");

   ScenarioMetrics(testcaselist);

}


void
UseCaseMetrics(list testcaselist, string e_USECASE)
{

   int totaltestcases = list_count (testcaselist);

   paragraph (gsValFormat_Sec2);
   print ("Number of Test Cases");
   PrintTestCaseActionsMetric(testcaselist);

//   paragraph (gsValFormat_Sec2);
//   print ("Test Case Generation Time");
//   PrintUCTestCaseGenerationMetric();

   paragraph (gsValFormat_Sec2);
   print ("Predicted Test Case Execution Time");
   PrintUCTestExecutionTime(totaltestcases);

   paragraph (gsValFormat_Sec2);
   print ("Predicted Test Case Evaluation Time");
   PrintUCTestEvaluationTime(totaltestcases);

}



void
PrintTestCaseActionsMetric(list testcaselist)
{

  int i,count, scenariocount;
  string testcase;
  list textlist;
  list actiondata;
  string  action, exercises, testunitid;
  int goodcount = 0;
  int badcount = 0;

  scenariocount = list_count (ScenarioList);
  count = list_count(testcaselist);

  for (i=0;i<count;i++)
    {

      testcase = list_get(testcaselist,i);

      textlist = string_to_list (testcase, "\n");

      actiondata = string_to_list ( list_get(textlist,0), SEPARATOR);
      action = list_get(actiondata, 0);

      exercises = list_get(actiondata, 1);
      testunitid = list_get(actiondata, 2);

      if (exercises == "GOOD")
         ++goodcount;
      else
         ++badcount;
    }

  paragraph (gsValFormat_testmetrics);
  print ("The Use Case contains : \t\t" + scenariocount + " \tScenario(s)");

  paragraph (gsValFormat_testmetrics);
  paragraph (gsValFormat_testmetrics);
  print ("Test Cases that Exercise the Use Case : \t" + goodcount + " \tTest Cases");
  paragraph (gsValFormat_testmetrics);
  print ("Test Cases that Do Not Exercise the Use Case : \t" + badcount + " \tTest Cases");

  paragraph (gsValFormat_testmetricsB);
  print ("Total Test Cases : \t\t" + count + " \tTest Cases");

}



void
PrintUCTestExecutionTime(int totaltestcases)
{
  int i,count;
  node scenario;

  string q1 = "item [OperationDuration && obj_id ==${scenario.id}]";
  string q2 = "item [TestDuration && obj_id ==${scenario.id}]";
  string q3 = "item [TimeUnit && obj_id ==${scenario.id}]";

  item itemvar1;
  float value1 = 0.0;
  item itemvar2, itemvar3;
  float value2 = 0.0;
  float screeningtime = 0.0;
  float alltime = 0.0;
  float ave = 0.0;
  string timeunit;

  list timelist;
  timelist = list_create("all", 0);

  count = list_count (ScenarioList);
  for (i=0;i<count;i++)
    {
      scenario = list_get(ScenarioList,i);

      itemvar1 = find_by_query(q1);
      itemvar2 = find_by_query(q2);
      itemvar3 = find_by_query(q3);

      if (itemvar1 != NULL)
        value1 = to_float(itemvar1.value);
      else
        value1 = 0.0;

      if (itemvar2 != NULL)
        value2 = value2 + to_float(itemvar2.value);
      else
        value2 = value2 + value1*2;

      if (itemvar3 != NULL)
        timeunit = itemvar3.value;
      else
        timeunit = "UNKNOWN";

      screeningtime = screeningtime + (3 * value2);
      alltime = alltime + (totaltestcases * value2);
    }

   ave = value2/(count);

   timelist = simplifytime(ave, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("Average Test Case : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

   timelist = simplifytime(screeningtime, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("Screening Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

   timelist = simplifytime(alltime, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("All Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));


}

list
simplifytime(float value, string time)
{


  list tmp;
  
  tmp = list_create("all",0);

  if (time == "hundredth_seconds" && value >= 10)
     {
       value = value / 10;
       time = "tenth_seconds";
     }


  if (time == "tenth_seconds" && value >= 10)
     {
       value = value / 10;
       time = "seconds";
     }


  if (time == "seconds" && value >= 60)
     {
       value = value / 60;
       time = "minutes";
     }


  if (time == "minutes"&& value >= 60)
     {
       value = value / 60;
       time = "hours";
     }

  list_append(tmp, value);
  list_append(tmp, time);



  return (tmp);

}



void
PrintUCTestEvaluationTime(int totaltestcases)
{
  int i,count;
  node scenario;

  string q1 = "item [OperationDuration && obj_id ==${scenario.id}]";
  string q2 = "item [EvaluationTime && obj_id ==${scenario.id}]";
  string q3 = "item [TimeUnit && obj_id ==${scenario.id}]";

  item itemvar1;
  float value1;
  item itemvar2, itemvar3;
  float value2 = 0.0;
  float screeningtime = 0.0;
  float alltime = 0.0;
  float ave = 0.0;
  string timeunit;


  list timelist;
  timelist = list_create("all",0);


  count = list_count (ScenarioList);
  for (i=0;i<count;i++)
    {
      scenario = list_get(ScenarioList,i);

      itemvar1 = find_by_query(q1);
      itemvar2 = find_by_query(q2);
      itemvar3 = find_by_query(q3);

      if (itemvar1 != NULL)
        value1 = to_float(itemvar1.value);
      else
        value1 = 0.0;

      if (itemvar2 != NULL)
        value2 = value2 + to_float(itemvar2.value);
      else 
        value2 = value2 + value1*2;

      if (itemvar3 != NULL)
        timeunit = itemvar3.value;
      else
        timeunit = "UNKNOWN";

      screeningtime = screeningtime + (3 * value2);
      alltime = alltime + (totaltestcases * value2);
    }

   ave = value2/(count);

   timelist = simplifytime(ave, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("Average Test Case : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

   timelist = simplifytime(screeningtime, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("Screening Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

   timelist = simplifytime(alltime, timeunit);
   paragraph(gsValFormat_testmetrics);
   printf ("All Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));


}


void
ScenarioMetrics(list testcaselist)
{
  int i,count;
  node scenario;
  float executiontime;
  int totaltestcases;

  count = list_count (ScenarioList);
  for (i=0;i<count;i++)
    {
      scenario = list_get(ScenarioList,i);

      paragraph(gsValFormat_Sec2);
      print ("Scenario: " + scenario.name);

      paragraph(gsValFormat_Sec3);
      print ("Number of Test Cases");
      totaltestcases = PrintScenarioMetrics(testcaselist, scenario.name);

      paragraph(gsValFormat_Sec3);
      print ("Normal Execution Time");
      executiontime = PrintScenarioExecutionMetric(scenario.id);

      paragraph(gsValFormat_Sec3);
      print ("Predicted Test Test Setup Time");
      PrintScenarioTestSetupMetric(scenario.id);


      paragraph(gsValFormat_Sec3);
      print ("Predicted Test Case Execution Time");
      PrintScenarioTestDurationMetric(totaltestcases, scenario.id, executiontime);

      paragraph(gsValFormat_Sec3);
      print ("Predicted Test Case Evaluation Time");
      PrintScenarioEvaluationMetric(totaltestcases, scenario.id, executiontime);
    }
}

int
PrintScenarioMetrics(list testcaselist, string scenario)
{
  int i,count;
  string testcase;
  list textlist;
  list actiondata;
  string  action, exercises, testunitid;
  int goodcount = 0;
  int badcount = 0;
  int totaltestcases = 0;


  count = list_count(testcaselist);

  for (i=0;i<count;i++)
    {

      testcase = list_get(testcaselist,i);

      textlist = string_to_list (testcase, "\n");

      actiondata = string_to_list ( list_get(textlist,0), SEPARATOR);
      action = list_get(actiondata, 0);

      exercises = list_get(actiondata, 1);
      testunitid = list_get(actiondata, 2);

      if (action == scenario)
         {
            if (exercises == "GOOD")
               ++goodcount;
            else
               ++badcount;
            ++totaltestcases;
         }
    }

  paragraph (gsValFormat_testmetrics);
  print ("Test Cases that Exercise the Scenario : \t" + goodcount + " \tTest Cases");
  paragraph (gsValFormat_testmetrics);
  print ("Test Cases that Do Not Exercise the Scenario : \t" + badcount + " \tTest Cases");
  paragraph (gsValFormat_testmetricsB);
  print ("Total Test Cases : \t" + totaltestcases + " \tTest Cases");

  return(totaltestcases);

}


void
PrintUCTestCaseGenerationMetric()
{
   int ExtractModel = 0;
   int VerifySDF = 0;
   int DesignTestCases = 0;
   int ElapsedTime;
   string tmp;
   list tmplist;


   tmp = read_file(OUTPUTDIR + "/measures_ExtractModel");
   tmp = string_search_and_replace(tmp, "\r", "");
   tmplist = string_to_list(tmp, "\n");
   tmp = list_get(tmplist, 0);
   ExtractModel = to_int (tmp);

   tmp = read_file(OUTPUTDIR + "/measures_VerifySDF");
   tmp = string_search_and_replace(tmp, "\r", "");
   tmplist = string_to_list(tmp, "\n");
   tmp = list_get(tmplist, 0);
   VerifySDF = to_int (tmp);

   tmp = read_file(OUTPUTDIR + "/measures_DesignTestCases");
   tmp = string_search_and_replace(tmp, "\r", "");
   tmplist = string_to_list(tmp, "\n");
   tmp = list_get(tmplist, 0);
   DesignTestCases = to_int (tmp);

   ElapsedTime = ExtractModel + VerifySDF + DesignTestCases;

   paragraph(gsValFormat_testmetrics);
   print ("Elapsed Time to Extract Test Information:\t" + ExtractModel + "\tseconds");

   paragraph(gsValFormat_testmetrics);
   print ("Elapsed Time to Verify Test Information:\t" + VerifySDF + "\tseconds");

   paragraph(gsValFormat_testmetrics);
   print ("Elapsed Time to Design Test Cases:\t" + DesignTestCases + "\tseconds");

   paragraph(gsValFormat_testmetricsB);
   print ("Total Elapsed Time to Create Test Cases:\t" + ElapsedTime + "\tseconds");


}


float
PrintScenarioExecutionMetric( int id)
{

  string q1 = "item [OperationDuration && obj_id ==${id}]";
  string q3 = "item [TimeUnit && obj_id ==${id}]";

  item itemvar1, itemvar3;
  float value1;
  string timeunit;

  list timelist;
  timelist = list_create("all",0);

  itemvar1 = find_by_query(q1);
  itemvar3 = find_by_query(q3);



  if (itemvar1 != NULL)
    value1 = to_float(itemvar1.value);
  else
    value1 = 0.0;

  if (itemvar3 != NULL)
    timeunit = itemvar3.value;
  else
    timeunit = "UNKNOWN";

  timelist = simplifytime(value1, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Required Execution Time for the Scenario : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));


  return (value1);
}

void
PrintScenarioTestSetupMetric(int id)
{

  string q1 = "item [SetUpTime && obj_id ==${id}]";
  string q3 = "item [TimeUnit && obj_id ==${id}]";

  item itemvar1, itemvar3;
  float value1;
  string timeunit;

  list timelist;
  timelist = list_create("all",0);

  itemvar1 = find_by_query(q1);
  itemvar3 = find_by_query(q3);



  if (itemvar1 != NULL)
    value1 = to_float(itemvar1.value);
  else
    value1 = 0.0;

  if (itemvar3 != NULL)
    timeunit = itemvar3.value;
  else
    timeunit = "UNKNOWN";

  timelist = simplifytime(value1, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Predicted Setup Time for the Scenario : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

}


void
PrintScenarioTestDurationMetric(int totaltestcases, int id, float executiontime)
{

  string q2 = "item [TestDuration && obj_id ==${id}]";
  string q3 = "item [TimeUnit && obj_id ==${id}]";

  list timelist;
  timelist = list_create("all",0);

  item itemvar2, itemvar3;
  float value2, screeningtime, alltime;
  string timeunit;

  itemvar2 = find_by_query(q2);
  itemvar3 = find_by_query(q3);



  if (itemvar2 != NULL)
    value2 = to_float(itemvar2.value);
  else
    value2 = executiontime*2;

  if (itemvar3 != NULL)
    timeunit = itemvar3.value;
  else
    timeunit = "UNKNOWN";

  screeningtime = 3 * value2;
  alltime = totaltestcases * value2;


  timelist = simplifytime(value2, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Average Test Case : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

  timelist = simplifytime(screeningtime, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Screening Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

  timelist = simplifytime(alltime, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("All Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

}




void
PrintScenarioEvaluationMetric(int totaltestcases, int id, float executiontime)
{

  string q2 = "item [EvaluationTime && obj_id ==${id}]";
  string q3 = "item [TimeUnit && obj_id ==${id}]";


  item itemvar2, itemvar3;
  float value2, screeningtime, alltime;
  string timeunit;


  list timelist;
  timelist = list_create("all",0);


  itemvar2 = find_by_query(q2);
  itemvar3 = find_by_query(q3);



  if (itemvar2 != NULL)
    value2 = to_float(itemvar2.value);
  else 
    value2 = executiontime*2;

  if (itemvar3 != NULL)
    timeunit = itemvar3.value;
  else
    timeunit = "UNKNOWN";

  screeningtime = 3 * value2;
  alltime = totaltestcases * value2;



  timelist = simplifytime(value2, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Predicted Evaluation Time for the Average Test Case : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

  timelist = simplifytime(screeningtime, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Predicted Evaluation Time for the Screening Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));

  timelist = simplifytime(alltime, timeunit);
  paragraph(gsValFormat_testmetrics);
  printf ("Predicted Evaluation Time for all Test Cases : \t%.2f \t%s", list_get(timelist,0), list_get(timelist,1));


}

void
PrintScenarioTestCases(list testcaselist, string e_USECASE)
{
  int i,count;
  string testcase;
  list textlist;
  list actiondata;
  string  action, pastaction, exercises, testunitid;
  int testid=0;
  list validlist;
  list testcasesummary;
  int j,count2;
  boolean firstaction = False;

  validlist = list_create("string",0);
  testcasesummary = list_create("string",0);

  count = list_count(testcaselist);

  firstaction = True;

  for (i=0;i<count;i++)
    {

      testcase = list_get(testcaselist,i);

      textlist = string_to_list (testcase, "\n");

      actiondata = string_to_list ( list_get(textlist,0), SEPARATOR);
      action = list_get(actiondata, 0);

      exercises = list_get(actiondata, 1);
      testunitid = list_get(actiondata, 2);


      if (i==0)
         pastaction = action;

      if (pastaction != action)
        {
//         PrintSummaryTable(testcasesummary, "Test Cases", pastaction);
           PrintCases(validlist, pastaction, e_USECASE);

           list_clear(validlist);
           list_clear(testcasesummary);
           firstaction = True;
        }


      list_append (validlist, testcase);
      list_append (testcasesummary, testunitid);

      pastaction = action;
    }

//  PrintSummaryTable(testcasesummary, "Test Cases", action);
    PrintCases(validlist, action, e_USECASE);

}

void
PrintCases(list validlist, string action, string e_USECASE)
{

   int count2,j;
   int testid; 
  
   count2 = list_count(validlist);

   paragraph (gsValFormat_Sec1);
   if ((target() == RTF))
     character_format_set(INHEAD);
   print ("Test Cases for Scenario: " + action );

   testid=0;
   for (j=0;j<count2;j++)
     {
       if (j) page();
       FormatTestCase (list_get(validlist,j), ++testid, e_USECASE);
     }

}

void 
FormatTestCase (string testcase, int testid, string e_USECASE)
{

  string st;
  int i,count;
  set probeset;
  list actiondata;
  string  action, exercises, testunitid, domaintype;
  int start = 0;
  probeset = set_create ("string");
  list tmpprobelist;
  list textlist;

  textlist = string_to_list(testcase,"\n");

  actiondata = string_to_list ( list_get(textlist,0), SEPARATOR);
  action = list_get(actiondata, 0);
  exercises = list_get(actiondata, 1);
  testunitid = list_get(actiondata, 2);


  paragraph (gsValFormat_P1);
  print ("Test Case : " + testid + "\n\tTest Execution ID : " + testunitid);

  paragraph (gsValFormat_EXER);
  if (exercises == "INVALID" )
    {
      print ("Evaluates exception for scenario " + action);
      print ("\n( Steps or entries after \"Exception\" may not be executable )");
    }
  else
    {
     print ("Evaluates scenario: " + action);
    }

  set_clear(probeset);
  start = 1;
  st = list_get(textlist,start);
  while ( string_find(st, 0, "<P3>Probes:") == 0 )
    {
      tmpprobelist = string_to_list(st, " ");
      set_add (probeset, list_get(tmpprobelist, 2) + SEPARATOR +  list_get(tmpprobelist, 1)  );

      st = string_search_and_replace(st,"invalid", "Exception");
      st = string_search_and_replace(st,"valid ", "");
      paragraph (gsValFormat_P3);
      print ( string_search_and_replace (st, "<P3>", "" ) );

      ++start;
      st = list_get(textlist,start);
    }

  paragraph(gsValFormat_EVAL);
  print ("Evaluation:\t____Pass\t_____Fail\t_____Skip\tDate:_____________\tInitial:_____________");
  paragraph(gsValFormat_EVAL);
//  if ( e_REPORT_TYPE == "html" )
//  {
    print ("Comments:\n");
    print ("_______________________________________________________________________\n");
    print ("_______________________________________________________________________\n");
    print ("_______________________________________________________________________\n");
    print ("_______________________________________________________________________\n");
    print ("_________________");
//  }
/*
  else
  {
    print ("Comments:");
    print ("___________________________________________________________________________");
    print ("___________________________________________________________________________");
    print ("___________________________________________________________________________");
    print ("___________________________________________________________________________");
    print ("_________________");

  }
  */
  paragraph(gsValFormat_EVAL);
  print ("====================================================================");


  FormatTestData (textlist, start, list_count(textlist), probeset, action, e_USECASE);

}


void
FormatTestData(list textlist, int start, int count, set probeset, string action, string e_USECASE)
{
  int i;
  string st;
  string probedata = "";
  list tmp;
  string probeline = "not_in_set";
  set actorset;
  string command;
  string printline, pg;
  boolean ExpectedOutput = False;
  boolean RegularLine = True;

  for (i=start; i<count; i++)
    {
       ExpectedOutput = False;
       RegularLine = True;
       st = list_get(textlist,i);

       if ( string_find (st, 0, "<P2>") == 0)
         {
           pg = gsValFormat_P2;
           printline =  ( string_search_and_replace (st, "<P2>", "" ) );
         }
       else if ( string_find (st, 0, "<P3>") == 0)
         {
           pg = gsValFormat_P3;
           printline =  ( string_search_and_replace (st, "<P3>", "" ) );
         }
       else if ( string_find (st, 0, "<IP4>") == 0)
         {
           pg = gsValFormat_P4;
           printline =  ( string_search_and_replace (st, "<IP4>", "" ) );
         }
       else if ( string_find (st, 0, "<OP4>") == 0)
         {
           pg = gsValFormat_P4;
           printline =  ( string_search_and_replace (st, "<OP4>", "" ) );
         }
       else if ( string_find (st, 0, "<P5>") == 0)
         {
           pg = gsValFormat_P5;
           printline =  ( string_search_and_replace (st, "<P5>", "" )  );
         }
       else if ( string_find (st, 0, "<DI>") == 0)
         {
           probeline = contains_probedata(st, probeset);
           if (probeline == "validprobe")
             {
               //pg = gsValFormat_BP6;
               pg = gsValFormat_P6;
               printline =  ( string_search_and_replace (st, "<DI>", "    " )  );
             }
           else if (probeline == "invalidprobe")
             {
               pg = gsValFormat_BP6;
               printline =  ( string_search_and_replace (st, "<DI>", "    " )  + " [ Exception: Invalid Data ]"  );
             }
           else
             {
               pg = gsValFormat_P6;
               // pg = gsValFormat_BP6;
               printline =  ( string_search_and_replace (st, "<DI>", "    " ) );
             }
         }
       else if ( string_find (st, 0, "<EVAL>") == 0)
         {
           pg = "EVAL";
           printline =  ( string_search_and_replace (st, "<EVAL>", "" )  );
         }
       else if (  string_find (st, 0, "<GR>") == 0)
         {
           command = string_search_and_replace (st, "<GR>", "" );
           PrintExpectedResults(command);
           ExpectedOutput = True;
           RegularLine = False;
         }
       else if ( string_find (st, 0, "<NO>") == 0)
         {
           pg = gsValFormat_EO1;
           printline =    ( string_search_and_replace (st, "<NO>", "" )  );
           ExpectedOutput = True;
         }
       else if ( string_find (st, 0, "<ER>") == 0)
         {
           command =   ( string_search_and_replace (st, "<ER>", "" )  );
           PrintFixedResults(command);
           ExpectedOutput = True;
           RegularLine = False;
         }


       if (ExpectedOutput && !RegularLine )
         {
           AddLines();
         }
       else if (ExpectedOutput && RegularLine )
         {
           paragraph (pg);
           print (printline);
           AddLines();
         }
       else if (!ExpectedOutput && RegularLine )
         {
           paragraph (pg);
           print (printline);
         }

    }

}


void
PrintExpectedResults(string command)
{
  string tmp;

  string sysdir = current_projdir() + current_system() + "/";
  tmp = "oraclecmd.exe cmd.exe /C \"" +COMMANDDIR + command +  " > " + sysdir + "output\"";
  // message ("<<syscall>>" + tmp);
  
  system (tmp);

  if(write_file_access(sysdir + "output"))
    {
      paragraph (gsValFormat_EO1);
      print ("Expected Result");
      tmp = read_file(sysdir + "output");
      tmp = string_search_and_replace(tmp, "\r", "");
      paragraph (gsValFormat_EO);
      print (tmp);
      system ("rm " + sysdir + "output");
    }
}



void
PrintFixedResults(string event_id)
{

  string query = "note [expectedoutput && obj_id == ${event_id}]";
  note notevar;

  notevar = find_by_query(query);

  paragraph (gsValFormat_EO1);
  print ("Expected Result");
  paragraph (gsValFormat_EO);
  print (notevar.desc);

}



string
contains_probedata(string st, set probeset)
{
  list st1, st2;
  string data;

  st1 = string_to_list(st, "<");
  st2 = string_to_list(list_get(st1, 1), ">");
  data = list_get(st2,0);



  if (set_is_member (probeset, data + SEPARATOR + "valid" ) )
    return ("validprobe");
  else if (set_is_member (probeset, data + SEPARATOR + "invalid" ) )
    return ("invalidprobe");
  else 
    return ("not_in_set");

}

string
EventName(string st)
{
  list st1, st2;
  string data;

  st1 = string_to_list(st, "<");
  st2 = string_to_list(list_get(st1, 1), ">");
  data = list_get(st2,0);

  return (data);

}

void
PrintTitlePage(string e_USECASE)
{

  paragraph(TITLE); // twice to get some distance
  paragraph(TITLE);
  print ("Test Specification");

  paragraph(SUBTITLE);
  print ("for");

  paragraph(SUBTITLE);
  print ("Use Case / Requirement" );

  paragraph(SUBTITLE);
  print ("");

  paragraph(SUBTITLE);
  print (e_USECASE);

  paragraph(DOCAUTHOR);
  print("\t" + e_DOCAUTHOR);
  paragraph(COMPANY);
  print("\t" + e_COMPANY);
  paragraph(DIVISION);
  print("\t" + e_DIVISION);
  if (e_DIVISION != " ")
     print("\n");

  paragraph(DOCTITLE);
  print("\tTest Specification");
  paragraph(DOCSUBTITLE);
  print("\tfor UseCase/Requirement " + e_USECASE);

  paragraph(DOCINFO);
  paragraph(DOCVERSION);
  print("Version:\t" + e_DOC_VERSION);

  paragraph(DOCINFO);
  print("Date of generation:\t" + time_to_string(time_now(), "%B %d, %Y at %I:%M %p\n"));
  print("Status:\t" + e_DOC_STATUS);

  //...Document Base:STPREPORT
  //...Pages:

  paragraph(DOCINFO);
  print("StP system: " + current_system() + "\n");
  print("StP project: ");
  character_format_set(EXTRASMALL);
  print(current_projdir() + "\n");

}

void
PrintSummaryTable(list summary, string caption, string scenario_name)
{
  int count,i;
  int num=0;
  float x,y;
  int increment = 0;

  count = list_count(summary);

  if (count == 0)
    return;

  paragraph (gsValFormat_Sec1);
  if ((target() == RTF))
     character_format_set(INHEAD);
  print ("Test Results Summary" );

  InitializeTable();


  for (i=0;i<count;i++)
    {
      Begin_Row();

      Make_Cell(width_1, NULL, NULL, NULL, NULL, NULL, to_string(++increment) );
      Make_Cell(width_2, NULL, NULL, NULL, NULL, NULL, " " );
      Make_Cell(width_3, NULL, NULL, NULL, NULL, NULL, " ");
      Make_Cell(width_4, NULL, NULL, NULL, NULL, NULL, " ");
      Make_Cell(width_5, NULL, NULL, NULL, NULL, NULL, list_get(summary,i) );

      End_Row();
    }

  End_Table();

  print_table(scenario_name, caption);

}




void 
InitializeTable()
{
   table_caption_placement_set(Top);
   table_width_set(6.5);

   table_caption_paragraph_format_set (gsValFormat_TableTitle);
   table_cell_bold_paragraph_format_set (gsValFormat_CellBody);
   table_cell_paragraph_format_set (gsValFormat_CellBody);
   // create title bar

   Begin_Table(5);

   Begin_Row();


   Make_Cell(width_1, NULL, "Shade0",
                      NULL, NULL, NULL, "Test Case");
   Make_Cell(width_2, NULL, "Shade0",
                      NULL, NULL, NULL, "Pass");
   Make_Cell(width_3, NULL, "Shade0",
                      NULL, NULL, NULL, "Fail");
   Make_Cell(width_4, NULL, "Shade0",
                      NULL, NULL, NULL, "Skip");
   Make_Cell(width_5, NULL, "Shade0",
                      NULL, NULL, NULL, "Test Execution ID");

   End_Row();


}

Test Cases that Exercise the Use Case :     4
void
AddLines()
{
  paragraph(gsValFormat_EVAL1);
  //if ( e_REPORT_TYPE == "htm" )
  //{
    print ("Observed Results:\n");
    print ("_______________________________________________________________________\n");
    print ("_______________________________________________________________________\n");
    print ("_______________________________________________________________________\n");
    print ("____________________________________________________________________\n");

  //}
  /*
  else
  {
    print ("Observed Results: ");
    print ("___________________________________________________________________________");
    print ("___________________________________________________________________________");
    print ("___________________________________________________________________________");
    print ("____________________________________________________________________");
  }
  */
}

/*
void initDebug()
{

    e_FORMAT_TESTCASE_DATA = True;
    e_USECASE   = "AdvancedORACLE";
    e_DOCAUTHOR = "Malcho";
    e_COMPANY   = "Wizcom Ltd";
    e_DIVISION  = "development";
    e_DOC_VERSION = "1.1";
    e_DOC_STATUS  = "Analysis";

}
*/
